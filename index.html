<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>水果老虎机</title>
<style>
  :root{ --ink:#ffe8b6; --muted:#c7b7d4; --win:#22c55e; --loss:#ef4444; }
  body{margin:0;background:linear-gradient(#2c0436,#4a0c5b);font:16px/1.5 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,"PingFang SC","Microsoft YaHei",sans-serif;color:var(--ink);display:flex;justify-content:center}
  .cabinet{width:min(420px,100%);padding:10px}
  .top{display:flex;gap:8px;justify-content:space-between;margin:6px 4px}
  .meter{flex:1;background:#2b0a39;border:2px solid #d7b27a;border-radius:10px;padding:6px 8px;color:#ffdfaf;display:flex;justify-content:space-between;align-items:center}
  .meter b{letter-spacing:4px;font-weight:900}
  .screen{background:radial-gradient(ellipse at center,#6f2b86,#3d165e 60%);border:4px solid #d7b27a;border-radius:18px;padding:10px;margin:6px 0}
  .grid{display:grid;grid-template-columns:repeat(6,1fr);grid-template-rows:repeat(6,48px);gap:6px;position:relative}
  .cell{display:flex;align-items:center;justify-content:center;border:2px solid #f5d6a0;border-radius:10px;background:linear-gradient(#ffe7c6,#f7d190);color:#7a1212;font-weight:900}
  .dim{opacity:.15}
  .active{box-shadow:0 0 0 3px #fff inset, 0 0 14px 4px #ffd166; background:#fff6d9}
  .center{grid-column:2/6;grid-row:2/6;border:2px dashed #ffdca8;border-radius:16px;background:rgba(0,0,0,.15);display:flex;align-items:center;justify-content:center;flex-direction:column}
  .title{font-weight:900;font-size:22px;letter-spacing:2px;margin:4px 0}
  .panel{display:flex;gap:8px;justify-content:space-between;margin-top:8px;flex-wrap:wrap}
  .small{background:#2b0a39;border:2px solid #d7b27a;border-radius:10px;padding:8px;color:#ffdfaf;display:flex;align-items:center;gap:6px}
  .btn{border:none;border-radius:16px;padding:12px 18px;font-weight:900;cursor:pointer}
  .btn.start{background:linear-gradient(#ff6b6b,#e11d48);color:#fff}
  .btn.blue{background:linear-gradient(#22ccff,#0ea5e9);color:#073b55}
  .mono{font-variant-numeric:tabular-nums}
  .msg{min-height:22px;text-align:center;margin-top:6px}
  .msg.win{color:var(--win)} .msg.lose{color:var(--loss)}
  .footer{color:#ffb4b4;text-align:center;margin:10px 0 16px;font-size:13px}
</style>
</head>
<body>
<div class="cabinet">
  <div class="top">
    <div class="meter"><span>奖金</span><b class="mono" id="prize">0</b></div>
    <div class="meter"><span>财富</span><b class="mono" id="balance">0</b></div>
  </div>

  <div class="screen">
    <div class="grid" id="grid">
      <!-- 外环 20 格（顺时针） -->
      <div class="cell" data-i="0">🍊10</div><div class="cell" data-i="1">🔔20</div><div class="cell" data-i="2">BAR×3</div>
      <div class="cell" data-i="3">BAR20</div><div class="cell" data-i="4">🍎5</div><div class="cell" data-i="5">🍋15</div>
      <div class="cell" data-i="19" style="grid-column:1;grid-row:2">🍋15</div>
      <div class="cell dim" style="grid-column:2;grid-row:2"></div><div class="cell dim" style="grid-column:3;grid-row:2"></div>
      <div class="cell dim" style="grid-column:4;grid-row:2"></div><div class="cell dim" style="grid-column:5;grid-row:2"></div>
      <div class="cell" data-i="6"  style="grid-column:6;grid-row:2">🥬20</div>
      <div class="cell" data-i="18" style="grid-column:1;grid-row:3">🍊10</div>
      <div class="center"><div class="title">水果老虎机</div><div class="mono" id="centerLED" style="font-size:28px">00</div></div>
      <div class="cell" data-i="7"  style="grid-column:6;grid-row:3">⭐×3</div>
      <div class="cell" data-i="17" style="grid-column:1;grid-row:4">⭐30</div>
      <div class="cell" data-i="8"  style="grid-column:6;grid-row:4">🍎×3</div>
      <div class="cell" data-i="16" style="grid-column:1;grid-row:5">Lucky</div>
      <div class="cell" data-i="9"  style="grid-column:6;grid-row:5">77</div>
      <div class="cell" data-i="15" style="grid-row:6">🥬×3</div><div class="cell" data-i="14" style="grid-row:6">🍊×3</div>
      <div class="cell" data-i="13" style="grid-row:6">⭐</div><div class="cell" data-i="12" style="grid-row:6">77×3</div>
      <div class="cell" data-i="11" style="grid-row:6">🔔20</div><div class="cell" data-i="10" style="grid-row:6">🍋15</div>
    </div>

    <div class="panel">
      <div class="small">下注：
        <select id="bet"><option>1</option><option>2</option><option>5</option><option>10</option><option>20</option></select>
      </div>
      <div class="small">兑换码：
        <input id="code" placeholder="例如 jerry" style="width:120px">
        <button class="btn blue" id="redeemBtn">兑换</button>
      </div>
      <button class="btn start" id="startBtn">开始</button>
    </div>

    <div id="msg" class="msg"></div>
  </div>
  <div class="footer">此程序由 ATW 王杰开发</div>
</div>

<script>
// ===== 配置 =====
const API = 'https://jerryatw.834833904.workers.dev'; // ← 换成你的 Workers 域名
let token = localStorage.getItem('slot_token') || '';
let balance = 0;
const cells = [...document.querySelectorAll('.cell[data-i]')];
let pos = 0;

// ===== 简单音效（AudioContext + 4 个音色）=====
let actx, buf = {};
function initAudio(){
  if (actx) return;
  actx = new (window.AudioContext||window.webkitAudioContext)();
  // 生成几种短音：click / tick / stop / win / lose
  buf.click = tone(440, 0.04);
  buf.tick  = tone(880, 0.03);
  buf.stop  = tone(220, 0.08);
  buf.win   = chord([523,659,783], 0.25);
  buf.lose  = tone(150, 0.25);
}
function tone(freq, dur){
  const sr=actx.sampleRate, len=Math.floor(sr*dur), b=actx.createBuffer(1,len,sr), d=b.getChannelData(0);
  for(let i=0;i<len;i++){ const t=i/sr; d[i]=Math.sin(2*Math.PI*freq*t) * Math.exp(-6*t); }
  return b;
}
function chord(freqs, dur){
  const sr=actx.sampleRate, len=Math.floor(sr*dur), b=actx.createBuffer(1,len,sr), d=b.getChannelData(0);
  for(let i=0;i<len;i++){ const t=i/sr; let v=0; for(const f of freqs) v+=Math.sin(2*Math.PI*f*t); d[i]=(v/freqs.length)*Math.exp(-3*t)*0.8; }
  return b;
}
function play(name, gain=1){
  if (!actx||!buf[name]) return;
  const src=actx.createBufferSource(); src.buffer=buf[name];
  const g=actx.createGain(); g.gain.value=gain;
  src.connect(g).connect(actx.destination); src.start();
}

// ===== UI 操作 =====
function setActive(i){
  cells.forEach(c=>c.classList.remove('active'));
  const el = document.querySelector(`.cell[data-i="${i}"]`);
  if (el) el.classList.add('active');
  pos = i;
}
function tickLED(n){ document.getElementById('centerLED').textContent = String(n).padStart(2,'0'); }
function setPrize(x){ document.getElementById('prize').textContent = x|0; }
function setBalance(x){ balance = x|0; document.getElementById('balance').textContent = balance; }
function showMsg(txt, ok){ const el=document.getElementById('msg'); el.textContent=txt; el.className='msg '+(ok?'win':'lose'); }

// 第一次点击任意按钮解锁音频
['startBtn','redeemBtn'].forEach(id=>{
  document.getElementById(id).addEventListener('click',()=>{ initAudio(); }, {once:true});
});

// 兑换码
document.getElementById('redeemBtn').onclick = async ()=>{
  try{
    const v = document.getElementById('code').value.trim();
    if (!v) return;
    const r = await fetch(`${API}/api/redeem`, { method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify({code:v}) });
    const d = await r.json(); if(!r.ok) throw new Error(d.error||'redeem failed');
    token=d.token; localStorage.setItem('slot_token', token); setBalance(d.balance);
    showMsg('兑换成功', true); play('win', .6);
  }catch(e){ showMsg(e.message, false); play('lose', .6); }
};

// 旋转
document.getElementById('startBtn').onclick = async ()=>{
  if(!token){ showMsg('请先输入兑换码', false); play('lose', .6); return; }
  try{
    play('click', .6);
    await previewSpin(40, 55); // 快速预转两圈
    const bet = Number(document.getElementById('bet').value);
    const r = await fetch(`${API}/api/spin`, {
      method:'POST', headers:{'content-type':'application/json','authorization':`Bearer ${token}`},
      body: JSON.stringify({ bet })
    });
    const d = await r.json(); if(!r.ok) throw new Error(d.error||'spin failed');
    token=d.token; localStorage.setItem('slot_token', token);
    await slowTo(d.index); // 减速停到后端给的 index
    setPrize(d.win); setBalance(d.balance);
    if (d.win>0){ showMsg(`恭喜中奖 +${d.win}`, true); play('win', .9); }
    else { showMsg(`未中奖 -${bet}`, false); play('lose', .7); }
  }catch(e){ showMsg(e.message, false); play('lose', .7); }
};

// 预转动画
function previewSpin(steps=40, interval=60){
  return new Promise(res=>{
    let k=0; const go=()=>{
      setActive((pos+1)%20); tickLED((pos+1)%100); play('tick', .25);
      if(++k>=steps) return res();
      setTimeout(go, interval);
    }; go();
  });
}
// 减速到目标
function slowTo(target){
  return new Promise(res=>{
    let remain = ((target - pos + 20) % 20) + 20; // 至少一圈
    let t = 80;
    const go=()=>{
      setActive((pos+1)%20); tickLED((pos+1)%100);
      remain--; play(remain? 'tick':'stop', remain? .25:.7);
      if(remain<=0) return res();
      t += 8; setTimeout(go, t);
    }; go();
  });
}

// 初始
setActive(0); tickLED(0); setPrize(0); setBalance(0);
</script>
</body>
</html>
