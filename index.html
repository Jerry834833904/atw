<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ATWä¸²ç„Šæœº4çº§è§£é”</title>
  <style>
    :root{
      --bg:#f5f5f7; --ink:#111; --muted:#8e8e93; --card:#fff;
      --border:#e5e5ea; --btnbg:#e9e9ec; --highlight:#16a34a;
    }
    html,body{height:100%;}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font:17px/1.7 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",sans-serif;
    }
    .wrap{min-height:100%;display:flex;flex-direction:column;align-items:center;padding:env(safe-area-inset-top) 16px 40px}
    .topbar{width:100%;max-width:640px;display:flex;justify-content:space-between;align-items:center;margin-top:8px}
    .btn{
      border:1px solid var(--border); border-radius:10px; background:var(--btnbg);
      padding:8px 12px; cursor:pointer; font-size:15px;color:#007aff;
    }
    #luggageBtn{ composes: btn; }
    .card{
      width:100%; max-width:640px; background:var(--card); border:1px solid var(--border);
      border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.06); padding:24px 20px; margin-top:12px;
      text-align:center;
    }
    .title{font-weight:800; font-size:22px; margin:0 0 14px}
    .input-row{margin:14px auto 10px; width:min(460px,100%)}
    input[type="text"]{
      width:100%; border:1px solid var(--border); border-radius:12px; padding:12px 14px; outline:none; font-size:16px;
      background:#fff; text-align:center;
    }
    .btn-wide{
      width:min(460px,100%); border:1px solid var(--border); border-radius:12px; background:var(--btnbg);
      padding:14px 16px; cursor:pointer; font-size:16px; font-weight:700; margin:8px auto 0; display:block;color:#007aff;
    }
    .muted{color:var(--muted)}
    .result{font-size:20px; font-weight:700; color:var(--highlight); min-height:1.6em; margin-top:14px}
    .err{color:#e64d4d; min-height:1.2em; margin-top:8px}
    .footer{max-width:720px; color:#e64d4d; font-size:13px; text-align:center; margin-top:18px}

    /* ç›¸æœºåŒºåŸŸ */
    .camera-wrap{margin:10px auto 4px; width:min(460px,100%);}
    video, canvas{width:100%; max-width:460px; border-radius:12px; border:1px solid var(--border);}
    #preview{display:none; margin-top:8px;}
    #canvas{display:none;}
    .cam-row{display:flex; gap:8px; justify-content:center; margin-top:8px;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div id="now" class="muted"></div>
      <div>
        <button id="ocrBtn" class="btn">ğŸ“· æ‹ç…§è¯†åˆ«</button>
        <button id="luggageBtn" class="btn">ğŸ§³ Luggage</button>
      </div>
    </div>

    <div class="card">
      <h1 class="title" id="title">ATWä¸²ç„Šæœº4çº§è§£é”</h1>

      <!-- ç›¸æœºé¢„è§ˆï¼ˆç‚¹å‡»â€œæ‹ç…§è¯†åˆ«â€åæ˜¾ç¤ºï¼‰ -->
      <div class="camera-wrap" id="camWrap" hidden>
        <video id="preview" autoplay playsinline muted></video>
        <canvas id="canvas"></canvas>
        <div class="cam-row">
          <button id="snapBtn" class="btn">ğŸ“¸ è¯†åˆ«æ­¤å¸§</button>
          <button id="closeCamBtn" class="btn">âœ– å…³é—­ç›¸æœº</button>
        </div>
        <div class="muted" style="font-size:13px; margin-top:6px;">
          æç¤ºï¼šå¯¹å‡†é»‘åº•ç™½å­—çš„ 5 ä½åºåˆ—å·åŒºåŸŸï¼Œå°½é‡å……æ»¡å–æ™¯æ¡†å¹¶ä¿æŒæ¸…æ™°ã€‚
        </div>
</div>

      <div class="input-row">
        <input id="sn" type="text" inputmode="numeric" autocomplete="off" placeholder="è¯·è¾“å…¥5ä½åºåˆ—å·" />
      </div>

      <button id="genBtn" class="btn-wide">ç”Ÿæˆå¯†ç </button>

      <div id="err" class="err"></div>
      <div id="res" class="result" data-raw-pwd=""></div>
    </div>

    <div id="foot" class="footer">æ­¤ç¨‹åºç”±å¥¥ç‰¹ç»´ç‹æ°å¼€å‘ï¼Œè¯·å‹¿è½¬å‘ï¼Œå¦‚è½¬å‘åæœè‡ªè´Ÿã€‚</div>
  </div>

  <!-- æµè§ˆå™¨ç«¯ OCRï¼ˆWASMï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <script>
    // ====== åç«¯åŸŸå ======
    const API_BASE = "https://atwjerry.834833904.workers.dev";

    // ====== å¤šè¯­è¨€æ–‡æ¡ˆ ======
    const i18n = {
      zh: {
        title: "å¥¥ç‰¹ç»´ä¸²ç„Šæœº4çº§è§£é”",
        placeholder: "è¯·è¾“å…¥5ä½åºåˆ—å·",
        gen: "ç”Ÿæˆå¯†ç ",
        resultPrefix: "å¯†ç æ˜¯ï¼š",
        errNaN: "åºåˆ—å·å¿…é¡»æ˜¯5ä½æ•°å­—",
        errRange: "åºåˆ—å·èŒƒå›´ä¸º 00000 - 99999",
        luggage: "ğŸ§³ Luggage",
        ocrOpen: "ğŸ“· æ‹ç…§è¯†åˆ«",
        ocrClose: "âœ– å…³é—­ç›¸æœº",
        ocrSnap: "ğŸ“¸ è¯†åˆ«æ­¤å¸§",
        tip: "æç¤ºï¼šå¯¹å‡†é»‘åº•ç™½å­—çš„ 5 ä½åºåˆ—å·åŒºåŸŸï¼Œå°½é‡å……æ»¡å–æ™¯æ¡†å¹¶ä¿æŒæ¸…æ™°ã€‚",
        footer: "æ­¤ç¨‹åºç”±å¥¥ç‰¹ç»´ç‹æ°å¼€å‘ï¼Œè¯·å‹¿è½¬å‘ï¼Œå¦‚è½¬å‘åæœè‡ªè´Ÿã€‚"
      },
      en: {
        title: "ATW Stringer L4 Unlock",
        placeholder: "Enter 5-digit serial number",
        gen: "Generate Password",
        resultPrefix: "Password: ",
        errNaN: "Serial number must be exactly 5 digits",
        errRange: "Valid range: 00000 - 99999",
        luggage: "ğŸ§³ Luggage",
        ocrOpen: "ğŸ“· Scan via Camera",
        ocrClose: "âœ– Close Camera",
        ocrSnap: "ğŸ“¸ Recognize Frame",
        tip: "Tip: Aim at the 5-digit white-on-black serial area; fill the view and keep it sharp.",
        footer: "Developed by ATW Jerry. Do not forward; you assume all consequences."
      }
    };
    let lang = "zh";

    // ====== DOM ======
    const nowEl = document.getElementById('now');
    const title = document.getElementById('title');
    const sn = document.getElementById('sn');
    const genBtn = document.getElementById('genBtn');
    const res = document.getElementById('res');
    const err = document.getElementById('err');
    const luggageBtn = document.getElementById('luggageBtn');

    const ocrBtn = document.getElementById('ocrBtn');
    const camWrap = document.getElementById('camWrap');
    const preview = document.getElementById('preview');
    const canvas = document.getElementById('canvas');
    const snapBtn = document.getElementById('snapBtn');
    const closeCamBtn = document.getElementById('closeCamBtn');

{
      const t = i18n[lang];
      title.textContent = t.title;
      sn.placeholder = t.placeholder;
      genBtn.textContent = t.gen;
      document.getElementById('foot').textContent = t.footer;
      luggageBtn.textContent = t.luggage;
      ocrBtn.textContent = t.ocrOpen;
      snapBtn.textContent = t.ocrSnap;
      closeCamBtn.textContent = t.ocrClose;
      if (res.dataset.rawPwd) res.textContent = t.resultPrefix + res.dataset.rawPwd;
      document.documentElement.lang = (lang === 'zh' ? 'zh-CN' : 'en');
      // ç›¸æœºæç¤ºæ–‡æ¡ˆ
      camWrap?.querySelector('.muted') && (camWrap.querySelector('.muted').textContent = t.tip);
    }

    // ===== é¡¶éƒ¨æ—¶é’Ÿ =====
function pad(n){ return String(n).padStart(2,'0'); }
    function tickLocal() {
      const d = new Date();
      nowEl.textContent =
        `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} `
        + `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }
    setInterval(tickLocal, 1000); tickLocal();

    // ===== ç›¸æœºæ§åˆ¶ & OCR =====
    let mediaStream = null;

    async function openCamera(){
      if (mediaStream) return; // å·²æ‰“å¼€
      try {
        mediaStream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: { ideal: 'environment' }, // åç½®
            width: { ideal: 1280 }, height: { ideal: 720 }
          },
          audio: false
        });
        preview.srcObject = mediaStream;
        preview.style.display = 'block';
        camWrap.hidden = false;
      } catch (e) {
        err.textContent = (lang === 'zh' ? 'æ— æ³•æ‰“å¼€ç›¸æœºï¼š' : 'Cannot open camera: ') + (e?.message || e);
      }
    }

    function closeCamera(){
      if (mediaStream){
        mediaStream.getTracks().forEach(t=>t.stop());
        mediaStream = null;
      }
      preview.srcObject = null;
      preview.style.display = 'none';
      camWrap.hidden = true;
    }

    async function snapAndOCR(){
      if (!preview.videoWidth){ err.textContent = lang==='zh'?'ç›¸æœºæœªå°±ç»ª':'Camera not ready'; return; }

      // æŠŠè§†é¢‘å¸§ç”»åˆ° canvas
      const w = preview.videoWidth, h = preview.videoHeight;
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(preview, 0, 0, w, h);

      // å–ä¸­éƒ¨ ROIï¼ˆå¯æŒ‰å®é™…ç•Œé¢å¾®è°ƒï¼‰
      const roiW = Math.floor(w * 0.7);
      const roiH = Math.floor(h * 0.20);
      const roiX = Math.floor((w - roiW) / 2);
      const roiY = Math.floor(h * 0.40);
      const roi = ctx.getImageData(roiX, roiY, roiW, roiH);

      // æ”¾è¿›ä¸´æ—¶ canvas ä¾¿äº OCR
      const tmp = document.createElement('canvas');
      tmp.width = roiW; tmp.height = roiH;
      tmp.getContext('2d').putImageData(roi, 0, 0);

      // é¢„å¤„ç†ï¼šæé«˜å¯¹æ¯”åº¦ï¼ˆé»‘åº•ç™½å­—åœºæ™¯ï¼‰
      const g = tmp.getContext('2d');
      const img = g.getImageData(0,0,roiW,roiH);
      const data = img.data;
      for (let i=0;i<data.length;i+=4){
        // ç°åº¦
        const gray = 0.299*data[i] + 0.587*data[i+1] + 0.114*data[i+2];
        // ç®€å•é˜ˆå€¼åŒ–
        const v = gray > 160 ? 255 : 0;
        data[i] = data[i+1] = data[i+2] = v;
      }
      g.putImageData(img,0,0);

      err.textContent = lang==='zh'?'è¯†åˆ«ä¸­â€¦':'Recognizingâ€¦';
      try{
        const { data: { text } } = await Tesseract.recognize(
          tmp.toDataURL(),
          'eng',
          {
            // ç™½åå•æ•°å­—ï¼›ç›¸å½“äºåªè®¤ 0-9
            tessedit_char_whitelist: '0123456789',
            classify_bln_numeric_mode: 1,
            preserve_interword_spaces: 0
          }
        );
        const digits = (text || '').replace(/\D+/g,'').slice(0,5);
        if (digits.length === 5){
          sn.value = digits;
          err.textContent = '';
          // è‡ªåŠ¨è°ƒç”¨ä½ çš„è®¡ç®—é€»è¾‘
          compute();
        } else {
          err.textContent = (lang==='zh'?'è¯†åˆ«å¤±è´¥ï¼Œè¯·é è¿‘/å¯¹å‡†åºåˆ—å·åŒºåŸŸé‡è¯•ã€‚ç»“æœï¼š':'Failed to recognize. Result: ') + (text||'').trim();
        }
      } catch(e){
        err.textContent = (lang==='zh'?'OCR å‡ºé”™ï¼š':'OCR error: ') + (e?.message || e);
      }
    }

    // ===== ä¸åç«¯å¯¹æ¥ä¿æŒä¸å˜ï¼šPOST /api/calc =====
 async function compute(){
      err.textContent = '';
      const t = i18n[lang];
      const raw = (sn.value || '').trim();

      if (!/^\d{5}$/.test(raw)){
        err.textContent = t.errNaN;
        res.textContent = '';
        res.dataset.rawPwd = '';
        return;
      }

      const n = Number(raw);
      if (n < 0 || n > 99999){
        err.textContent = t.errRange;
        res.textContent = '';
        res.dataset.rawPwd = '';
        return;
      }

      try {
        const clientEpochMs = Date.now();
        const tzOffsetMin = new Date().getTimezoneOffset();
        const r = await fetch(`${API_BASE}/api/calc`, {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ sn: raw, clientEpochMs, tzOffsetMin })
        });
        const data = await r.json();
        if (!r.ok) throw new Error(data?.error || ("HTTP " + r.status));
        res.dataset.rawPwd = data.pwd;
        res.textContent = t.resultPrefix + data.pwd;
      } catch (e) {
        err.textContent = (lang === 'zh' ? "è¯·æ±‚å¤±è´¥ï¼š" : "Request failed: ") + (e?.message || e);
        res.dataset.rawPwd = '';
        res.textContent = '';
      }
    }

    // ===== äº‹ä»¶ç»‘å®š =====
    genBtn.addEventListener('click', compute);
    sn.addEventListener('keydown', e => { if (e.key === 'Enter') compute(); });
    sn.addEventListener('input', e => { e.target.value = e.target.value.replace(/\D/g, '').slice(0,5); });

    // è¯­è¨€åˆ‡æ¢ï¼ˆå¤ç”¨ä½ çš„è¡ŒææŒ‰é’®ï¼‰
    luggageBtn.addEventListener('click', () => { lang = (lang === 'zh' ? 'en' : 'zh'); applyI18n(); });

    // ç›¸æœºæŒ‰é’®
    ocrBtn.addEventListener('click', openCamera);
    snapBtn.addEventListener('click', snapAndOCR);
    closeCamBtn.addEventListener('click', closeCamera);

    // åˆå§‹
    function applyI18n(){ /* å·²åœ¨ä¸Šé¢å®šä¹‰ï¼Œæ­¤å¤„ä¿æŒå¼•ç”¨ä¸€è‡´ */ }
    applyI18n();
  </script>
</body>
</html>
