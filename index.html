<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ATW串焊机4级解锁</title>
  <style>
    :root{
      --bg:#f5f5f7; --ink:#111; --muted:#8e8e93; --card:#fff;
      --border:#e5e5ea; --btnbg:#e9e9ec; --highlight:#16a34a;
    }
    html,body{height:100%;}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font:17px/1.7 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",sans-serif;
    }
    .wrap{min-height:100%;display:flex;flex-direction:column;align-items:center;padding:env(safe-area-inset-top) 16px 40px}
    .topbar{width:100%;max-width:640px;display:flex;justify-content:space-between;align-items:center;margin-top:8px}
    .btn{
      border:1px solid var(--border); border-radius:10px; background:var(--btnbg);
      padding:8px 12px; cursor:pointer; font-size:15px;color:#007aff;
    }
    #luggageBtn{ composes: btn; }
    .card{
      width:100%; max-width:640px; background:var(--card); border:1px solid var(--border);
      border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.06); padding:24px 20px; margin-top:12px;
      text-align:center;
    }
    .title{font-weight:800; font-size:22px; margin:0 0 14px}
    .input-row{margin:14px auto 10px; width:min(460px,100%)}
    input[type="text"]{
      width:100%; border:1px solid var(--border); border-radius:12px; padding:12px 14px; outline:none; font-size:16px;
      background:#fff; text-align:center;
    }
    .btn-wide{
      width:min(460px,100%); border:1px solid var(--border); border-radius:12px; background:var(--btnbg);
      padding:14px 16px; cursor:pointer; font-size:16px; font-weight:700; margin:8px auto 0; display:block;color:#007aff;
    }
    .muted{color:var(--muted)}
    .result{font-size:20px; font-weight:700; color:var(--highlight); min-height:1.6em; margin-top:14px}
    .err{color:#e64d4d; min-height:1.2em; margin-top:8px}
    .footer{max-width:720px; color:#e64d4d; font-size:13px; text-align:center; margin-top:18px}

    /* 相机区域 */
    .camera-wrap{margin:10px auto 4px; width:min(460px,100%);}
    video, canvas{width:100%; max-width:460px; border-radius:12px; border:1px solid var(--border);}
    #preview{display:none; margin-top:8px;}
    #canvas{display:none;}
    .cam-row{display:flex; gap:8px; justify-content:center; margin-top:8px;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div id="now" class="muted"></div>
      <div>
        <button id="ocrBtn" class="btn">📷 拍照识别</button>
        <button id="luggageBtn" class="btn">🧳 Luggage</button>
      </div>
    </div>

    <div class="card">
      <h1 class="title" id="title">ATW串焊机4级解锁</h1>

      <!-- 相机预览（点击“拍照识别”后显示） -->
      <div class="camera-wrap" id="camWrap" hidden>
        <video id="preview" autoplay playsinline muted></video>
        <canvas id="canvas"></canvas>
        <div class="cam-row">
          <button id="snapBtn" class="btn">📸 识别此帧</button>
          <button id="closeCamBtn" class="btn">✖ 关闭相机</button>
        </div>
        <div class="muted" style="font-size:13px; margin-top:6px;">
          提示：对准黑底白字的 5 位序列号区域，尽量充满取景框并保持清晰。
        </div>
</div>

      <div class="input-row">
        <input id="sn" type="text" inputmode="numeric" autocomplete="off" placeholder="请输入5位序列号" />
      </div>

      <button id="genBtn" class="btn-wide">生成密码</button>

      <div id="err" class="err"></div>
      <div id="res" class="result" data-raw-pwd=""></div>
    </div>

    <div id="foot" class="footer">此程序由奥特维王杰开发，请勿转发，如转发后果自负。</div>
  </div>

  <!-- 浏览器端 OCR（WASM） -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <script>
    // ====== 后端域名 ======
    const API_BASE = "https://atwjerry.834833904.workers.dev";

    // ====== 多语言文案 ======
    const i18n = {
      zh: {
        title: "奥特维串焊机4级解锁",
        placeholder: "请输入5位序列号",
        gen: "生成密码",
        resultPrefix: "密码是：",
        errNaN: "序列号必须是5位数字",
        errRange: "序列号范围为 00000 - 99999",
        luggage: "🧳 Luggage",
        ocrOpen: "📷 拍照识别",
        ocrClose: "✖ 关闭相机",
        ocrSnap: "📸 识别此帧",
        tip: "提示：对准黑底白字的 5 位序列号区域，尽量充满取景框并保持清晰。",
        footer: "此程序由奥特维王杰开发，请勿转发，如转发后果自负。"
      },
      en: {
        title: "ATW Stringer L4 Unlock",
        placeholder: "Enter 5-digit serial number",
        gen: "Generate Password",
        resultPrefix: "Password: ",
        errNaN: "Serial number must be exactly 5 digits",
        errRange: "Valid range: 00000 - 99999",
        luggage: "🧳 Luggage",
        ocrOpen: "📷 Scan via Camera",
        ocrClose: "✖ Close Camera",
        ocrSnap: "📸 Recognize Frame",
        tip: "Tip: Aim at the 5-digit white-on-black serial area; fill the view and keep it sharp.",
        footer: "Developed by ATW Jerry. Do not forward; you assume all consequences."
      }
    };
    let lang = "zh";

    // ====== DOM ======
    const nowEl = document.getElementById('now');
    const title = document.getElementById('title');
    const sn = document.getElementById('sn');
    const genBtn = document.getElementById('genBtn');
    const res = document.getElementById('res');
    const err = document.getElementById('err');
    const luggageBtn = document.getElementById('luggageBtn');

    const ocrBtn = document.getElementById('ocrBtn');
    const camWrap = document.getElementById('camWrap');
    const preview = document.getElementById('preview');
    const canvas = document.getElementById('canvas');
    const snapBtn = document.getElementById('snapBtn');
    const closeCamBtn = document.getElementById('closeCamBtn');

{
      const t = i18n[lang];
      title.textContent = t.title;
      sn.placeholder = t.placeholder;
      genBtn.textContent = t.gen;
      document.getElementById('foot').textContent = t.footer;
      luggageBtn.textContent = t.luggage;
      ocrBtn.textContent = t.ocrOpen;
      snapBtn.textContent = t.ocrSnap;
      closeCamBtn.textContent = t.ocrClose;
      if (res.dataset.rawPwd) res.textContent = t.resultPrefix + res.dataset.rawPwd;
      document.documentElement.lang = (lang === 'zh' ? 'zh-CN' : 'en');
      // 相机提示文案
      camWrap?.querySelector('.muted') && (camWrap.querySelector('.muted').textContent = t.tip);
    }

    // ===== 顶部时钟 =====
function pad(n){ return String(n).padStart(2,'0'); }
    function tickLocal() {
      const d = new Date();
      nowEl.textContent =
        `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} `
        + `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }
    setInterval(tickLocal, 1000); tickLocal();

    // ===== 相机控制 & OCR =====
    let mediaStream = null;

    async function openCamera(){
      if (mediaStream) return; // 已打开
      try {
        mediaStream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: { ideal: 'environment' }, // 后置
            width: { ideal: 1280 }, height: { ideal: 720 }
          },
          audio: false
        });
        preview.srcObject = mediaStream;
        preview.style.display = 'block';
        camWrap.hidden = false;
      } catch (e) {
        err.textContent = (lang === 'zh' ? '无法打开相机：' : 'Cannot open camera: ') + (e?.message || e);
      }
    }

    function closeCamera(){
      if (mediaStream){
        mediaStream.getTracks().forEach(t=>t.stop());
        mediaStream = null;
      }
      preview.srcObject = null;
      preview.style.display = 'none';
      camWrap.hidden = true;
    }

    async function snapAndOCR(){
      if (!preview.videoWidth){ err.textContent = lang==='zh'?'相机未就绪':'Camera not ready'; return; }

      // 把视频帧画到 canvas
      const w = preview.videoWidth, h = preview.videoHeight;
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(preview, 0, 0, w, h);

      // 取中部 ROI（可按实际界面微调）
      const roiW = Math.floor(w * 0.7);
      const roiH = Math.floor(h * 0.20);
      const roiX = Math.floor((w - roiW) / 2);
      const roiY = Math.floor(h * 0.40);
      const roi = ctx.getImageData(roiX, roiY, roiW, roiH);

      // 放进临时 canvas 便于 OCR
      const tmp = document.createElement('canvas');
      tmp.width = roiW; tmp.height = roiH;
      tmp.getContext('2d').putImageData(roi, 0, 0);

      // 预处理：提高对比度（黑底白字场景）
      const g = tmp.getContext('2d');
      const img = g.getImageData(0,0,roiW,roiH);
      const data = img.data;
      for (let i=0;i<data.length;i+=4){
        // 灰度
        const gray = 0.299*data[i] + 0.587*data[i+1] + 0.114*data[i+2];
        // 简单阈值化
        const v = gray > 160 ? 255 : 0;
        data[i] = data[i+1] = data[i+2] = v;
      }
      g.putImageData(img,0,0);

      err.textContent = lang==='zh'?'识别中…':'Recognizing…';
      try{
        const { data: { text } } = await Tesseract.recognize(
          tmp.toDataURL(),
          'eng',
          {
            // 白名单数字；相当于只认 0-9
            tessedit_char_whitelist: '0123456789',
            classify_bln_numeric_mode: 1,
            preserve_interword_spaces: 0
          }
        );
        const digits = (text || '').replace(/\D+/g,'').slice(0,5);
        if (digits.length === 5){
          sn.value = digits;
          err.textContent = '';
          // 自动调用你的计算逻辑
          compute();
        } else {
          err.textContent = (lang==='zh'?'识别失败，请靠近/对准序列号区域重试。结果：':'Failed to recognize. Result: ') + (text||'').trim();
        }
      } catch(e){
        err.textContent = (lang==='zh'?'OCR 出错：':'OCR error: ') + (e?.message || e);
      }
    }

    // ===== 与后端对接保持不变：POST /api/calc =====
 async function compute(){
      err.textContent = '';
      const t = i18n[lang];
      const raw = (sn.value || '').trim();

      if (!/^\d{5}$/.test(raw)){
        err.textContent = t.errNaN;
        res.textContent = '';
        res.dataset.rawPwd = '';
        return;
      }

      const n = Number(raw);
      if (n < 0 || n > 99999){
        err.textContent = t.errRange;
        res.textContent = '';
        res.dataset.rawPwd = '';
        return;
      }

      try {
        const clientEpochMs = Date.now();
        const tzOffsetMin = new Date().getTimezoneOffset();
        const r = await fetch(`${API_BASE}/api/calc`, {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ sn: raw, clientEpochMs, tzOffsetMin })
        });
        const data = await r.json();
        if (!r.ok) throw new Error(data?.error || ("HTTP " + r.status));
        res.dataset.rawPwd = data.pwd;
        res.textContent = t.resultPrefix + data.pwd;
      } catch (e) {
        err.textContent = (lang === 'zh' ? "请求失败：" : "Request failed: ") + (e?.message || e);
        res.dataset.rawPwd = '';
        res.textContent = '';
      }
    }

    // ===== 事件绑定 =====
    genBtn.addEventListener('click', compute);
    sn.addEventListener('keydown', e => { if (e.key === 'Enter') compute(); });
    sn.addEventListener('input', e => { e.target.value = e.target.value.replace(/\D/g, '').slice(0,5); });

    // 语言切换（复用你的行李按钮）
    luggageBtn.addEventListener('click', () => { lang = (lang === 'zh' ? 'en' : 'zh'); applyI18n(); });

    // 相机按钮
    ocrBtn.addEventListener('click', openCamera);
    snapBtn.addEventListener('click', snapAndOCR);
    closeCamBtn.addEventListener('click', closeCamera);

    // 初始
    function applyI18n(){ /* 已在上面定义，此处保持引用一致 */ }
    applyI18n();
  </script>
</body>
</html>
