<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ATW串焊机4级解锁</title>
  <style>
    :root{ --bg:#f5f5f7; --ink:#111; --muted:#8e8e93; --card:#fff;
           --border:#e5e5ea; --btnbg:#e9e9ec; --highlight:#16a34a; }
    html,body{height:100%;}
    body{ margin:0; background:var(--bg); color:var(--ink);
          font:17px/1.7 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",sans-serif; }
    .wrap{min-height:100%;display:flex;flex-direction:column;align-items:center;padding:env(safe-area-inset-top) 16px 40px}
    .topbar{width:100%;max-width:640px;display:flex;justify-content:space-between;align-items:center;margin-top:8px}
    #luggageBtn{border:1px solid var(--border); border-radius:10px; background:var(--btnbg); padding:8px 12px; cursor:pointer; font-size:15px;color:#007aff;}
    .card{ width:100%; max-width:640px; background:var(--card); border:1px solid var(--border);
           border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.06); padding:24px 20px; margin-top:12px; text-align:center; }
    .title{font-weight:800; font-size:22px; margin:0 0 14px}
    .input-row{margin:14px auto 10px; width:min(460px,100%)}
    input[type="text"]{ width:100%; border:1px solid var(--border); border-radius:12px; padding:12px 14px; outline:none; font-size:16px; background:#fff; text-align:center; }
    .btn-wide{ width:min(460px,100%); border:1px solid var(--border); border-radius:12px; background:var(--btnbg);
               padding:14px 16px; cursor:pointer; font-size:16px; font-weight:700; margin:8px auto 0; display:block;color:#007aff; }
    .muted{color:var(--muted)}
    .result{font-size:20px; font-weight:700; color:var(--highlight); min-height:1.6em; margin-top:14px}
    .err{color:#e64d4d; min-height:1.2em; margin-top:8px}
    .footer{max-width:720px; color:#e64d4d; font-size:13px; text-align:center; margin-top:18px}

    /* 相机面板（可见视频框） */
    .cam-panel{ width:min(640px,100%); background:#fff; border:1px solid var(--border); border-radius:14px;
                box-shadow:0 10px 30px rgba(0,0,0,.06); padding:12px; margin-top:12px; }
    .cam-row{display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-top:8px;}
    video, canvas{ width:100%; max-width:600px; border-radius:12px; border:1px solid var(--border); background:#000; }
    .note{font-size:13px; color:#666; margin-top:6px}
    .live{font-size:16px; color:#222; text-align:center; margin:6px 0 0;}
    .live b{font-variant-numeric: tabular-nums;}

    /* 选图输入移到屏外但可点击（iOS 允许 programmatic click） */
    #fileInput{ position:fixed; left:-9999px; top:0; width:1px; height:1px; opacity:0; pointer-events:auto; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div id="now" class="muted"></div>
      <div><button id="luggageBtn">🧳 Luggage</button></div>
    </div>

    <div class="card">
      <h1 class="title" id="title">ATW串焊机4级解锁</h1>

      <div class="input-row">
        <input id="sn" type="text" inputmode="numeric" autocomplete="off" placeholder="请输入5位序列号" />
      </div>

      <!-- 原有按钮 -->
      <button id="genBtn" class="btn-wide">生成密码</button>

      <!-- 新增：拍照/语音 -->
      <button id="ocrBtn" class="btn-wide">📷 拍照识别</button>
      <button id="voiceBtn" class="btn-wide">🎤 语音识别</button>

      <div id="err" class="err"></div>
      <div id="res" class="result" data-raw-pwd=""></div>
    </div>

    <!-- 相机面板 -->
<div id="camPanel" class="cam-panel" hidden>
      <div class="muted" id="camTitle">相机预览（若黑屏，请确保 HTTPS / 允许相机权限 / 非无痕模式）</div>
      <video id="preview" playsinline autoplay muted></video>
      <canvas id="frame" hidden></canvas>
      <div class="live">实时识别：<b id="liveNum">—</b></div>
      <div class="cam-row">
        <button id="startAuto" class="btn-wide" style="max-width:210px;">启动相机（自动）</button>
        <button id="snap" class="btn-wide" style="max-width:210px;">识别此帧</button>
        <button id="pickImg" class="btn-wide" style="max-width:210px;">选择图片识别</button>
        <button id="closeCam" class="btn-wide" style="max-width:210px;">关闭相机</button>
      </div>
      <div class="note">提示：相机不可用时会自动切换为“拍照/选图”。</div>
    </div>

    <div id="foot" class="footer">此程序由奥特维王杰开发，请勿转发，如转发后果自负。</div>
  </div>

  <input id="fileInput" type="file" accept="image/*" capture="environment" />
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <script>
    /* ================= 基础文案与界面 ================= */
    const API_BASE = "https://atwjerry.834833904.workers.dev";
    const i18n = {
      zh:{ title:"奥特维串焊机4级解锁", placeholder:"请输入5位序列号",
           gen:"生成密码", ocr:"📷 拍照识别", voice:"🎤 语音识别",
           resultPrefix:"密码是：", errNaN:"序列号必须是5位数字",
           errRange:"序列号范围为 00000 - 99999",
           errOCR:"识别失败，请靠近/对准序列号区域重试。",
           errCam:"相机不可用：", errASRNo:"此浏览器不支持语音识别",
           errASR:"语音识别错误：", tipListening:"正在听…请说5位数字（中文）",
           luggage:"🧳 Luggage", footer:"此程序由奥特维王杰开发，请勿转发，如转发后果自负。",
           camTitle:"相机预览（若黑屏，请确保 HTTPS / 允许权限 / 非无痕）" },
      en:{ title:"ATW Stringer L4 Unlock", placeholder:"Enter 5-digit serial number",
           gen:"Generate Password", ocr:"📷 Scan via Camera", voice:"🎤 Speech Input",
           resultPrefix:"Password: ", errNaN:"Serial number must be exactly 5 digits",
           errRange:"Valid range: 00000 - 99999",
           errOCR:"Recognition failed. Try moving closer or adjust the angle.",
           errCam:"Camera error: ", errASRNo:"Speech recognition is not supported in this browser",
           errASR:"Speech recognition error: ", tipListening:"Listening… please say five digits (English)",
           luggage:"🧳 Luggage", footer:"Developed by ATW Jerry. Do not forward; you assume all consequences.",
           camTitle:"Camera preview (If black, ensure HTTPS / permission / not private mode)" }
    };
    let lang="zh";

    const nowEl=document.getElementById('now');
    function pad(n){return String(n).padStart(2,'0');}
    setInterval(()=>{ const d=new Date();
      nowEl.textContent=`${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    },1000);
const titleEl=document.getElementById('title');
    const sn=document.getElementById('sn');
    const genBtn=document.getElementById('genBtn');
    const ocrBtn=document.getElementById('ocrBtn');
    const voiceBtn=document.getElementById('voiceBtn');
    const luggageBtn=document.getElementById('luggageBtn');
    const foot=document.getElementById('foot');
    const err=document.getElementById('err');
    const res=document.getElementById('res');

    const camPanel=document.getElementById('camPanel');
    const camTitle=document.getElementById('camTitle');
    const preview=document.getElementById('preview');
    const frame=document.getElementById('frame');
    const startAuto=document.getElementById('startAuto');
    const snap=document.getElementById('snap');
    const closeCam=document.getElementById('closeCam');
    const pickImg=document.getElementById('pickImg');
    const fileInput=document.getElementById('fileInput');
    const liveNum=document.getElementById('liveNum');

    function applyI18n(){
      const t=i18n[lang];
      titleEl.textContent=t.title; sn.placeholder=t.placeholder;
      genBtn.textContent=t.gen; ocrBtn.textContent=t.ocr; voiceBtn.textContent=t.voice;
      luggageBtn.textContent=t.luggage; foot.textContent=t.footer; camTitle.textContent=t.camTitle;
      if(res.dataset.rawPwd) res.textContent=t.resultPrefix+res.dataset.rawPwd;
      document.documentElement.lang=(lang==='zh'?'zh-CN':'en');
      // 更新语音提示文字
      liveNum.textContent='—';
    }

    /* ================= 业务：计算密码 ================= */
    async function compute(){
      err.textContent=''; const t=i18n[lang];
      const raw=(sn.value||'').trim();
      if(!/^\d{5}$/.test(raw)){ err.textContent=t.errNaN; res.textContent=''; res.dataset.rawPwd=''; return; }
      const n=Number(raw);
      if(n<0||n>99999){ err.textContent=t.errRange; res.textContent=''; res.dataset.rawPwd=''; return; }
      try{
        const r=await fetch(`${API_BASE}/api/calc`,{
          method:"POST", headers:{"content-type":"application/json"},
          body:JSON.stringify({ sn:raw, clientEpochMs:Date.now(), tzOffsetMin:new Date().getTimezoneOffset() })
        });
        const data=await r.json(); if(!r.ok) throw new Error(data?.error||("HTTP "+r.status));
        res.dataset.rawPwd=data.pwd; res.textContent=t.resultPrefix+data.pwd;
      }catch(e){ err.textContent=(lang==='zh'?'请求失败：':'Request failed: ')+(e?.message||e); res.dataset.rawPwd=''; res.textContent=''; }
    }

    sn.addEventListener('input', e=>{ e.target.value=e.target.value.replace(/\D/g,'').slice(0,5); });
    genBtn.addEventListener('click', compute);
    sn.addEventListener('keydown', e=>{ if(e.key==='Enter') compute(); });
    luggageBtn.addEventListener('click', ()=>{ lang=(lang==='zh'?'en':'zh'); applyI18n(); });

    /* ================= 图像：自动寻带 + 预处理 + 投票 ================= */
    function toGray(r,g,b){ return 0.299*r + 0.587*g + 0.114*b; }

    function findDarkBand(ctx){
      const {width:w, height:h} = ctx.canvas;
      const rowStep = Math.max(1, Math.floor(h/200));
      const bandH   = Math.max(12, Math.floor(h * 0.10));
      const id = ctx.getImageData(0,0,w,h).data;
      let bestY = 0, bestScore = -1e9;
      // 既看“黑”(均值小)，也看“对比度”(局部方差大)
for (let y=0; y<h-bandH; y+=rowStep){
        let m=0,cnt=0; let s2=0;
        for (let yy=y; yy<y+bandH; yy+=rowStep){
          for (let x=0; x<w; x+=4){
            const j=(yy*w + x)*4;
            const g=toGray(id[j],id[j+1],id[j+2]);
            m+=g; s2+=g*g; cnt++;
          }
        }
        m/=cnt; const varv = s2/cnt - m*m; // 方差
        const score = -m + Math.sqrt(Math.max(0,varv)); // 黑且有对比
        if (score > bestScore){ bestScore = score; bestY = y; }
      }
      const x = Math.floor(w * 0.10);
      const cw = Math.floor(w * 0.80);
      const y = Math.max(0, Math.min(h-bandH, bestY - Math.floor(bandH*0.15)));
      const ch = Math.min(h - y, Math.floor(bandH * 1.35));
      const roi = ctx.getImageData(x,y,cw,ch);
      const cv = document.createElement('canvas');
      cv.width = cw; cv.height = ch;
      cv.getContext('2d').putImageData(roi,0,0);
      return cv;
    }

    function boxBlur(ctx, r=1){
      const {width, height} = ctx.canvas;
      const id = ctx.getImageData(0,0,width,height);
      const src = id.data, out = new Uint8ClampedArray(src.length);
      for(let y=0;y<height;y++){
        for(let x=0;x<width;x++){
          let rs=0,gs=0,bs=0,cnt=0;
          for(let dy=-r;dy<=r;dy++){
            const yy=y+dy; if(yy<0||yy>=height) continue;
            for(let dx=-r;dx<=r;dx++){
              const xx=x+dx; if(xx<0||xx>=width) continue;
              const i=(yy*width+xx)*4; rs+=src[i]; gs+=src[i+1]; bs+=src[i+2]; cnt++;
            }
          }
          const o=(y*width+x)*4; out[o]=rs/cnt; out[o+1]=gs/cnt; out[o+2]=bs/cnt; out[o+3]=255;
        }
      }
      id.data.set(out); ctx.putImageData(id,0,0);
    }

    function unsharp(ctx, k=0.8){
      const {width, height} = ctx.canvas;
      const base = ctx.getImageData(0,0,width,height);
      const blurC = document.createElement('canvas'); blurC.width=width; blurC.height=height;
      const b = blurC.getContext('2d'); b.putImageData(base,0,0); boxBlur(b,1);
      const blur = b.getImageData(0,0,width,height).data; const d=base.data;
      for(let i=0;i<d.length;i+=4){
        d[i]=Math.min(255,Math.max(0,d[i]+(d[i]-blur[i])*k));
        d[i+1]=Math.min(255,Math.max(0,d[i+1]+(d[i+1]-blur[i+1])*k));
        d[i+2]=Math.min(255,Math.max(0,d[i+2]+(d[i+2]-blur[i+2])*k));
      } ctx.putImageData(base,0,0);
    }

    function binarize(ctx, th=165, invert=false){
      const {width, height} = ctx.canvas;
      const id=ctx.getImageData(0,0,width,height), d=id.data;
      for(let i=0;i<d.length;i+=4){
        const g=toGray(d[i],d[i+1],d[i+2]);
        const v=g>th?255:0; const p=invert?255-v:v;
        d[i]=d[i+1]=d[i+2]=p; d[i+3]=255;
      } ctx.putImageData(id,0,0);
    }

    function upscale(cv, s=2){
      const o=document.createElement('canvas'); o.width=Math.round(cv.width*s); o.height=Math.round(cv.height*s);
      const c=o.getContext('2d'); c.imageSmoothingEnabled=false; // 保留硬边缘
      c.drawImage(cv,0,0,o.width,o.height); return o;
    }

    // 自适应阈值：基于 ROI 均值/方差生成一组阈值
function genThresholds(cv){
      const ctx=cv.getContext('2d'); const {width:w,height:h}=cv;
      const d=ctx.getImageData(0,0,w,h).data;
      let m=0,s2=0,c=0;
      for(let i=0;i<d.length;i+=4){ const g=toGray(d[i],d[i+1],d[i+2]); m+=g; s2+=g*g; c++; }
      m/=c; const sd=Math.sqrt(Math.max(0, s2/c - m*m));
      const arr=[m+0.2*sd, m+0.35*sd, m+0.5*sd, 150, 170, 190]
        .map(x=>Math.max(110, Math.min(210, Math.round(x))));
      return Array.from(new Set(arr)); // 去重
    }

    async function ocrVariants(cv){
      const variants=[];
      const scales=[1.8,2.4,3.2];
      const thresholds=genThresholds(cv);
      const inverts=[false,true];
      const psms=[7,8];
      for(const sc of scales){
        const up=upscale(cv,sc); const c=up.getContext('2d'); unsharp(c,0.8);
        for(const th of thresholds){ for(const inv of inverts){ for(const psm of psms){
          const test=document.createElement('canvas'); test.width=up.width; test.height=up.height;
          const tc=test.getContext('2d'); tc.drawImage(up,0,0); binarize(tc,th,inv);
          const {data:{text}}=await Tesseract.recognize(test.toDataURL(),'eng',
            { tessedit_char_whitelist:'0123456789', tessedit_pageseg_mode:psm, classify_bln_numeric_mode:1 });
          const d=(text||'').replace(/\D+/g,'').slice(0,5);
          if(d){ variants.push(d); liveNum.textContent=d; } // 实时显示候选
        }}}
      }
      const count={}; for(const v of variants){ count[v]=(count[v]||0)+1; }
      let best='',score=-1; Object.keys(count).forEach(k=>{ const s=count[k]+(k.length===5?3:0); if(s>score){score=s;best=k;} });
      return best.slice(0,5);
    }

    /* ================= 相机：自动循环 + 手动帧 + 选图识别 ================= */
    let mediaStream=null, autoTimer=null, autoTries=0, ocrBusy=false;

    function canUseGUM(){
      return !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) &&
             (window.isSecureContext || location.hostname==='localhost');
    }

    async function startCamera(){
      if(!canUseGUM()){ err.textContent=i18n[lang].errCam+"非 HTTPS 或浏览器不支持，将使用选图方式"; return false; }
      try{
        mediaStream=await navigator.mediaDevices.getUserMedia({
          video:{ facingMode:{ideal:'environment'}, width:{ideal:1280}, height:{ideal:720} }, audio:false
        });
        preview.srcObject=mediaStream;
        await new Promise(res=>{ if(preview.readyState>=2) res(); else preview.onloadedmetadata=res; });
        await preview.play().catch(()=>{});
        return true;
      }catch(e){
        err.textContent=i18n[lang].errCam+(e?.message||e)+"；请改用“选择图片识别”。";
        return false;
      }
    }

    function stopCamera(){
      if(mediaStream){ mediaStream.getTracks().forEach(t=>t.stop()); mediaStream=null; }
      preview.srcObject=null;
      if(autoTimer){ clearInterval(autoTimer); autoTimer=null; }
      ocrBusy=false; autoTries=0; liveNum.textContent='—';
    }

    async function captureAndOCRFromVideoOnce(){
      if(!(preview.videoWidth>0)) return null;
      // 防并发
      if(ocrBusy) return null;
      ocrBusy = true;
      try{
        frame.width=preview.videoWidth; frame.height=preview.videoHeight;
        const ctx=frame.getContext('2d',{willReadFrequently:true});
        ctx.drawImage(preview,0,0,frame.width,frame.height);

        // 连拍三帧投票
const take=()=>{ const cvs=document.createElement('canvas'); cvs.width=frame.width; cvs.height=frame.height;
          cvs.getContext('2d',{willReadFrequently:true}).drawImage(preview,0,0,cvs.width,cvs.height); return cvs; };
        const frames=[take(),take(),take()];
        const votes=[];
        for(const f of frames){
          const c=f.getContext('2d',{willReadFrequently:true});
          const roi=findDarkBand(c);
          const d=await ocrVariants(roi);
          if(d) votes.push(d);
        }
        const tally={}; votes.forEach(v=>tally[v]=(tally[v]||0)+1);
        let best='',score=-1; Object.keys(tally).forEach(k=>{ const s=tally[k]+(k.length===5?2:0); if(s>score){score=s;best=k;} });
        return best || null;
      } finally {
        ocrBusy = false;
      }
    }

    async function startAutoLoop(){
      const ok = await startCamera();
      if(!ok) return;
      err.textContent='';
      autoTries=0;
      autoTimer=setInterval(async ()=>{
        autoTries++;
        const best = await captureAndOCRFromVideoOnce();
        if(best && best.length===5){
          sn.value=best; err.textContent=''; stopCamera(); camPanel.hidden=true; await compute();
        }else if(autoTries>=25){ // 最多试 25 次
          err.textContent=i18n[lang].errOCR+"（自动识别超时，可手动点“识别此帧”或“选择图片识别”）";
          clearInterval(autoTimer); autoTimer=null;
        }
      }, 800);
    }

    async function captureManual(){
      if(mediaStream) {
        const best = await captureAndOCRFromVideoOnce();
        if(best && best.length===5){ sn.value=best; await compute(); }
        else err.textContent=i18n[lang].errOCR;
      } else {
        await pickImageAndOCR();
      }
    }

    async function pickImageAndOCR(){
      fileInput.value=''; fileInput.click();
      const imgURL=await new Promise(resolve=>{
        fileInput.onchange=()=>{
          if(fileInput.files && fileInput.files[0]){
            const fr=new FileReader(); fr.onload=()=>resolve(fr.result); fr.readAsDataURL(fileInput.files[0]);
          } else resolve(null);
        };
      });
      if(!imgURL){ err.textContent=i18n[lang].errCam+'未选择图片'; return; }
      const img=new Image(); img.src=imgURL; await img.decode();
      const c=document.createElement('canvas'); c.width=img.naturalWidth; c.height=img.naturalHeight;
      const cx=c.getContext('2d',{willReadFrequently:true}); cx.drawImage(img,0,0);
      const roi=findDarkBand(cx);
      const digits=await ocrVariants(roi);
      if(digits && digits.length===5){ sn.value=digits; await compute(); }
      else err.textContent=i18n[lang].errOCR;
    }

    // 面板与按钮
ocrBtn.addEventListener('click', ()=>{ camPanel.hidden=false; });
    startAuto.addEventListener('click', startAutoLoop);
    snap.addEventListener('click', captureManual);
    pickImg.addEventListener('click', pickImageAndOCR);
    closeCam.addEventListener('click', ()=>{ stopCamera(); camPanel.hidden=true; });

    /* ================= 语音（按页面语言各自识别） ================= */
    const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;

    function mapChineseDigitsToArabic(txt){
      const map={'零':'0','〇':'0','○':'0','Ｏ':'0','０':'0',
                 '一':'1','二':'2','三':'3','四':'4','五':'5','六':'6','七':'7','八':'8','九':'9'};
      return txt.replace(/[零〇○Ｏ０一二三四五六七八九]/g, ch => map[ch] || ch);
    }
    function mapEnglishDigitsToArabic(txt){
      const words=[['zero','oh','o','owe'],['one'],['two','to','too'],['three'],['four','for'],['five'],
                   ['six'],['seven'],['eight','ate'],['nine']];
      let s=' '+txt.toLowerCase().replace(/[-,._]/g,' ')+' ';
      words.forEach((alts,d)=>alts.forEach(w=>{ s=s.replace(new RegExp('\\b'+w+'\\b','g'),' '+d+' ');} ));
      return s.replace(/\s+/g,' ');
    }

    voiceBtn.addEventListener('click', ()=>{
      const t=i18n[lang]; err.textContent='';
      if(!SpeechRec){ err.textContent=t.errASRNo; return; }
      const rec=new SpeechRec();
      rec.interimResults=false; rec.maxAlternatives=1;
      // 只按当前页面语言识别
      if(lang==='zh'){ rec.lang='zh-CN'; } else { rec.lang='en-US'; }
      try{ rec.start(); }catch(_){}
      err.textContent=t.tipListening;

      rec.onresult = async (ev)=>{
        let txt = ev.results[0][0].transcript || '';
        let norm = txt;
        if(lang==='zh'){ norm = mapChineseDigitsToArabic(norm); }
        else { norm = mapEnglishDigitsToArabic(norm); }
        const digits = norm.replace(/\D+/g,'').slice(0,5);
        if(digits.length===5){ sn.value = digits; err.textContent=''; await compute(); }
        else{ err.textContent = t.errNaN + '（' + txt + '）'; }
      };
      rec.onerror = (e)=>{ err.textContent = t.errASR + (e?.error || e); };
    });

    /* ================= 启动 ================= */
    applyI18n();
  </script>
</body>
</html>
